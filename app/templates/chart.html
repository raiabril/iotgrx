{% extends "base.html" %}

{% block content %}
  <div class="row">
    <div class="col-md-9">
      <div class="content-section text-center">
        <h4 class="text-center">{{sensor.name}}</h4>
        {% if values.__len__() > 0%}
        <p class="text-center">{{updated_value}}{{sensor.units}} at <span id="last_update_time">{{updated_time}}</span></p>
        {% endif %}
        <div class="chart-container">
          {% if values.__len__() > 0%}
          <canvas id="myChart" height="340px" width="100%"></canvas>
          {% else %}
          <p>No data for sensor retrieved.</p>
          {% endif %}
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="content-section text-center">
        <h5>Device data</h5>
        <p>
          Device: {{device.name}}<br>
          Boot: {{boot_count}}
        </p>
        <h5>Sensor data</h5>
        <p>
          {% if sensor.units %}
          Units: {{sensor.units}}<br>
          {% endif %}
          Type: {{sensor.sensor_type}}
        </p>
        <hr>
        <h5>Last measure</h5>
        <p>
          {% if updated_real_value %}
          Real: {{updated_real_value}}
          {% if sensor.units %}
          {{sensor.units}} <br>
          {% endif %}
          {% endif %}
          Calibrated: {{updated_value}} {{sensor.units}} <br>
          Measure Raw: {{updated_value_raw}}
        </p>

        <form method="POST" action="" enctype="multipart/form-data">
          {{form.hidden_tag()}}
            <fieldset class="form-group">
              <div class="row">
                <div class="container col-md-6">
                  <div class="form-group">
                    {{form.id.label(class="form-control-label")}}
                    {%if form.id.errors%}
                          {{form.id(class="form-control form-control-md is-invalid")}}
                          <div class="invalid-feedback">
                              {%for error in form.id.errors%}
                                  <span>{{error}}</span>
                              {%endfor%}
                          </div>
                      {%else%}
                          {{form.id(class="form-control form-control-md")}}    
                      {%endif%}
                  </div>
                </div>
                <div class="container col-md-6">
                  <div class="form-group">
                    {{form.real_value.label(class="form-control-label")}}
                    {%if form.real_value.errors%}
                        {{form.real_value(class="form-control form-control-md is-invalid")}}
                        <div class="invalid-feedback">
                            {%for error in form.real_value.errors%}
                                <span>{{error}}</span>
                            {%endfor%}
                        </div>
                    {%else%}
                        {{form.real_value(class="form-control form-control-md")}}    
                    {%endif%}
                  </div>
                </div>
              </div>
              <div class="container" style="display: flex; align-items: center; justify-content: center;">
                <div class="form-group">
                  <br>
                  {{form.submit(class="btn btn-outline-info")}}
                </div>
              </div>
            </fieldset>
        </form>
        <h5>Calibration</h4>
        <p>
          y = a0 + x*a1<br>
          a0 = {{sensor.a0}}<br>
          a1 = {{sensor.a1}}
        </p>
        {% if device.watering %}
        <hr>
        <a href="{{url_for('water.check', device_code=device.code)}}">Watering system</a>
        {% endif %}
      </div>
    </div>
  </div>




    <script>
    var ctx = document.getElementById('myChart').getContext('2d');
    document.getElementById('last_update_time').innerHTML = moment.utc("{{ updated_time }}")._d.toLocaleString();

    var myChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: [
            {% for label in labels %}
            moment.utc("{{ label }}"),
            {% endfor %}
          ],
          datasets: [
            {
              label: "Sensor reading",
              data: [
              {% for item in values %}
              {{ item }},
              {% endfor %}
              ],
              backgroundColor: "{{colorFill}}",
              borderColor: "{{colorLine}}",
              borderWidth: 2
            },
            {
              type: "scatter",
              label: "Manual measurement",
              labels: [
                {% for label in real_values_labels %}
                moment.utc("{{ label }}"),
                {% endfor %}
              ],
              data: [
                {% for item in real_values %}
                {{ item }},
                {% endfor %}
              ],
              backgroundColor: "rgba(0,0,0,0.5)",
              radius: {{real_radius}}
            }
          ]
        },
        options: {
          responsive:true,
          maintainAspectRatio:false,
          legend: {
            display: false
          },
          elements: {
              point:{
                radius: 0
              }
          },
          scales: {
            yAxes: [
              {
                ticks: {
                    steps:10,
                    beginAtZero: false
                }
              }
            ],
            xAxes: [
              {
                ticks: {
                    display:true,
                    maxTicksLimit: 8
                },
                distribution: 'linear',
                type: 'time',
                time: {
                    unit: 'day',
                    unitStepSize: 1,
                    displayFormats: {
                        'day': 'MMM DD'
                    }
                }
              }
            ]
          }
        }
      }
    );
    </script>
{% endblock %}